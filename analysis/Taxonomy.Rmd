---
title: "Analysis"
author: "John Sterrett"
date: "2023-1-6"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Note: This  requires microshades, which can be installed using
# remotes::install_github("KarstensLab/microshades")
# and speedyseq, which can be installed here
# remotes::install_github("mikemc/speedyseq")


pacman::p_load(tidyverse,
               data.table,
               ggplot2,
               phyloseq,
               patchwork,
               microshades,
               cowplot)


kable.mod.cols <- c("Estimate", "Std. Error", "deg. freedom", "t value", "p")
```

# Load data
```{r}
source("metaphlan_to_phyloseq_helper.R")
bugslist <- fread("../hiv.t32.concat.humann/all_bugs_list.tsv") %>% as.data.frame()
rownames(bugslist) <- bugslist$`#clade_name`
bugslist <- bugslist %>% 
    select(-c(`#clade_name`,
               NCBI_tax_id,
               additional_species))

# just get the lowest tax level. We can collapse again later
bugslist <- filter_mphlan_by_taxonomy_level(bugslist, level="max")

# replace NA with 0
bugslist[is.na(bugslist)] <- 0

# check that our data are relative abundance adding up to 100 still
hundreds <- rep(100, ncol(bugslist))
names(hundreds) <- colnames(bugslist)
if (isFALSE(all.equal(target=hundreds, 
                      current=colSums(bugslist, na.rm=T), 
                      tolerance=0.001))){
    print("Data are NOT relative abundances summing to 100! Please check what's going on.")
}

# create tax table
bugs <- rownames(bugslist)
taxonomy.table <- names_to_tax_table(bugs)
rownames(taxonomy.table) <- bugs

# read metadata
metadata <- fread("../metadata.txt") %>% as.data.frame()
rownames(metadata) <- metadata$PID

# create phyloseq object
pseq <- phyloseq(otu_table=otu_table(bugslist, taxa_are_rows=T),
                 tax_table=tax_table(taxonomy.table),
                 sample_data=sample_data(metadata)
                 )

```

# Taxa barplot {.tabset}
## All taxa
```{r, warning=T, fig.height=8}
# prep the microshades colors
mdf_prep <- prep_mdf(pseq, subgroup_level="Genus")
# sort the phylum names
phylum_table <- tax_glom(pseq, taxrank="Phylum", ) %>% otu_table()
phyla.otunames <- rownames(phylum_table)

phylums <- taxonomy.table[phyla.otunames,"Phylum"]

sorted_phylums <- phylums[order(rowSums(phylum_table), decreasing=T)]
# create the colors object
color_objs_GP <- create_color_dfs(mdf_prep, selected_groups = sorted_phylums[5:1], 
                                  cvd = TRUE)
# Extract
mdf_GP <- color_objs_GP$mdf
cdf_GP <- color_objs_GP$cdf
# create a custom legend
GP_legend <-custom_legend(mdf_GP, cdf_GP, 
                          legend_key_size=unit(0.4, "cm"),
                          legend_text_size=10)

# plot
plot <- plot_microshades(mdf_GP, cdf_GP)
plot_1 <- plot + scale_y_continuous(labels = scales::percent, expand = expansion(0)) +
  theme(legend.position = "none")  +
  theme(axis.text.x = element_text(size= 7)) +
  facet_grid(~HIV_Status, scales="free_x", space="free_x"
             #labeller=labeller(Osteosarcoma=ost.names)
             )

multi <- plot_grid(plot_1, GP_legend,  rel_widths = c(1, .25))
multi
ggsave("../figures/taxa-bar-phyum-genus-microshades.pdf",plot=multi,height=6,width=10)
```


## All taxa - Phylum (species microshades) with expanded prevotella
```{r,  warning=T, fig.height=9, fig.width=8}
# prep the microshades colors
mdf_prep <- prep_mdf(pseq, subgroup_level="Species")

# create the colors object
# was going to force prevotella in, but it's already the top
color_objs_GP <- create_color_dfs(mdf_prep, selected_groups = sorted_phylums[5:1], group_level="Phylum", subgroup_level="Species",
                                  cvd = TRUE,)
color_objs_GP <- extend_group(color_objs_GP$mdf, color_objs_GP$cdf,
                              "Phylum", "Species", "Bacteroidetes",
                              existing_palette="micro_cvd_purple", new_palette = "micro_purple",
                              n_add=2)

# Extract
mdf_GP <- color_objs_GP$mdf
cdf_GP <- color_objs_GP$cdf
# create a custom legend
GP_legend <-custom_legend(mdf_GP, cdf_GP, 
                          legend_key_size=unit(0.4, "cm"),
                          legend_text_size=10,
                          group_level="Phylum",
                          subgroup_level="Species")

# plot
plot <- plot_microshades(mdf_GP, cdf_GP)
plot_1 <- plot + scale_y_continuous(labels = scales::percent, expand = expansion(0)) +
  theme(legend.position = "none")  +
  theme(axis.text.x = element_text(size= 7)) +
  facet_grid(~HIV_Status, scales = "free_x", space="free_x"
             #labeller=labeller(Osteosarcoma=ost.names)
             )

multi <- plot_grid(plot_1, GP_legend,  rel_widths = c(1, .25))
multi
#ggsave("../figures/taxa-bar-phyum-genus-microshades.pdf",plot=multi,height=6,width=10)
```

## All taxa - Genus (species microshades) with expanded prevotella
```{r, warning=T, fig.height=9, fig.width=8}
# prep the microshades colors
mdf_prep <- prep_mdf(pseq, subgroup_level="Species")

# create the colors object
# was going to force prevotella in, but it's already the top

# sort the genus names
genus_table <- tax_glom(pseq, taxrank="Genus", ) %>% otu_table()
genus.otunames <- rownames(genus_table)

genera <- taxonomy.table[genus.otunames,"Genus"]

sorted_genera <- genera[order(rowSums(genus_table), decreasing=T)]

color_objs_GP <- create_color_dfs(mdf_prep, selected_groups = sorted_genera[5:1], group_level="Genus", subgroup_level="Species",
                                  cvd = TRUE,)
color_objs_GP <- extend_group(color_objs_GP$mdf, color_objs_GP$cdf,
                              "Genus", "Species", "Prevotella",
                              existing_palette="micro_cvd_purple", new_palette = "micro_purple",
                              n_add=4)

# Extract
mdf_GP <- color_objs_GP$mdf
cdf_GP <- color_objs_GP$cdf

#make other other black
#cdf_GP[cdf_GP$hex=="#F5F5F5", "hex"] <- "#000000"
# create a custom legend
GP_legend <-custom_legend(mdf_GP, cdf_GP, 
                          legend_key_size=unit(0.4, "cm"),
                          legend_text_size=10,
                          group_level="Genus",
                          subgroup_level="Species")

# plot
plot <- plot_microshades(mdf_GP, cdf_GP,)
plot_1 <- plot + scale_y_continuous(labels = scales::percent, expand = expansion(0)) +
  theme(legend.position = "none")  +
  theme(axis.text.x = element_text(size= 7)) +
  facet_grid(~HIV_Status, scales = "free_x", space="free_x"
             #labeller=labeller(Osteosarcoma=ost.names)
             )

  # facet_grid(Phylum~HIV_Status, scales = "free", space="free_x"
  #            #labeller=labeller(Osteosarcoma=ost.names)
  #            )


multi <- plot_grid(plot_1, GP_legend,  rel_widths = c(1, .25))
multi
#ggsave("../figures/taxa-bar-phyum-genus-microshades.pdf",plot=multi,height=6,width=10)
```


# Prevotella specifically
```{r}
prev.only <- subset_taxa(pseq, Genus=="Prevotella") %>% 
    tax_glom(taxrank="Species") 
prev.only.df <- prev.only %>% otu_table() %>% as.data.frame()
prev.only.tax <- prev.only %>% tax_table() %>% as.data.frame()

# grab just the species level
splitted <- lapply(rownames(prev.only.df),
      FUN=function(x) strsplit(x, split="\\|")[[1]][7])
# clean name and reassign rowname
splitted <- gsub("[a-z]__", "", splitted)
rownames(prev.only.df) <- splitted

# calculate total relative abundance of prevotella in each sample
total.prev <- colSums(prev.only.df)

# calculate total relative abundance of prevotella copri in each sample
copri.names <- splitted[grepl("copri", splitted)]
total.copri <- colSums(prev.only.df[copri.names,])

# calculate total non-copri prevotella
total.noncopri <- total.prev - total.copri

prev.stats <- data.frame("Prevotella"=total.prev, 
                         "Prevotella_copri"=total.copri, 
                         "Prevotella_noncopri"=total.noncopri)
prev.stats$HIV <- metadata$HIV_Status
```

## Relative abundance boxplots {.tabset}
### Prevotella
```{r}
ggplot(data=prev.stats,
       mapping=aes(y=Prevotella, x=HIV)) +
    geom_boxplot() + 
    theme_bw()
```

### Prevotella copri {.tabset}
#### Relative abundance
```{r}
ggplot(data=prev.stats,
       mapping=aes(y=Prevotella_copri, x=HIV)) +
    geom_boxplot() + 
    theme_bw()
```
#### As percent of all Prevotella
```{r}
ggplot(data=prev.stats,
       mapping=aes(y=Prevotella_copri/(Prevotella+0.001), x=HIV)) +
    geom_boxplot() + 
    theme_bw()
```

### Prevotella non-copri {.tabset}
#### Relative abundance
```{r}
ggplot(data=prev.stats,
       mapping=aes(y=Prevotella_noncopri, x=HIV)) +
    geom_boxplot() + 
    theme_bw()
```

#### As percent of all Prevotella
```{r}
ggplot(data=prev.stats,
       mapping=aes(y=Prevotella_noncopri/(Prevotella+0.001), x=HIV)) +
    geom_boxplot() + 
    theme_bw()
```
